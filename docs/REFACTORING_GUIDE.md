# é¡¹ç›®é‡æ„å®æ–½æŒ‡å—

## æ¶æ„å¯¹æ¯”

### å½“å‰æ¶æ„ï¼ˆç‹¬ç«‹å®ç°ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   HTTP Service      â”‚  â”‚   RPC Service    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   HTTP Handler      â”‚  â”‚   RPC Handler    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   HTTP Biz Layer    â”‚  â”‚   RPC Biz Layer  â”‚  âŒ é‡å¤
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   HTTP DAL Layer    â”‚  â”‚   RPC DAL Layer  â”‚  âŒ é‡å¤
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Database      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨èæ¶æ„ï¼ˆå…±äº«ä¸šåŠ¡é€»è¾‘ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   HTTP Service      â”‚  â”‚   RPC Service    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  HTTP Adapter       â”‚  â”‚   RPC Adapter    â”‚  âœ… è–„å±‚ï¼ˆåè®®è½¬æ¢ï¼‰
        â”‚  (Handler)          â”‚  â”‚   (Handler)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   DTO Converter   â”‚  âœ… è½¬æ¢å±‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Business Logic  â”‚  âœ… å…±äº«ä¸šåŠ¡é€»è¾‘
                    â”‚   (Service Layer) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Repository      â”‚  âœ… æ¥å£å®šä¹‰
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   DAL Layer       â”‚  âœ… å…±äº«æ•°æ®è®¿é—®
                    â”‚   (DB/Cache/MQ)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Database      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é‡æ„æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºåŸºç¡€ç›®å½•ç»“æ„

```bash
./scripts/refactor-project.sh
```

### ç¬¬ 2 æ­¥ï¼šå®šä¹‰é¢†åŸŸæ¨¡å‹å’Œä»“å‚¨æ¥å£

#### internal/biz/domain/user.go
åˆ›å»ºçº¯ç²¹çš„ä¸šåŠ¡å®ä½“ï¼Œä¸ä¾èµ–ä»»ä½•æ¡†æ¶ã€‚

#### internal/biz/repository/interfaces.go
å®šä¹‰æ•°æ®è®¿é—®çš„æŠ½è±¡æ¥å£ï¼Œéµå¾ªä¾èµ–å€’ç½®åŸåˆ™ã€‚

### ç¬¬ 3 æ­¥ï¼šå®ç°å…±äº«çš„ä¸šåŠ¡é€»è¾‘å±‚

#### internal/biz/service/adhoc_service.go
å°†å½“å‰ `serviceimpl/http/biz/` ä¸­çš„ä¸šåŠ¡é€»è¾‘æå–åˆ°è¿™é‡Œã€‚

**é‡æ„åŸåˆ™**:
- ä¸šåŠ¡é€»è¾‘ä¸åè®®æ— å…³
- åªä¾èµ–æŠ½è±¡æ¥å£ï¼ˆrepositoryï¼‰
- è¿”å›é¢†åŸŸæ¨¡å‹æˆ– proto message

### ç¬¬ 4 æ­¥ï¼šå®ç°å…±äº«çš„æ•°æ®è®¿é—®å±‚

#### internal/dal/db/user_repository_impl.go
å°† `serviceimpl/http/dal/` ä¸­çš„æ•°æ®åº“æ“ä½œä»£ç ç§»åŠ¨åˆ°è¿™é‡Œã€‚

**é‡æ„åŸåˆ™**:
- å®ç° repository æ¥å£
- å¤„ç†æ‰€æœ‰æ•°æ®åº“äº¤äº’
- é”™è¯¯è½¬æ¢ä¸ºé¢†åŸŸé”™è¯¯

### ç¬¬ 5 æ­¥ï¼šåˆ›å»º HTTP DTO å±‚

#### internal/dto/http/adhoc.go
å®šä¹‰ HTTP ä¸“ç”¨çš„è¯·æ±‚/å“åº”ç»“æ„ã€‚

**åŒ…å«å†…å®¹**:
- HTTP è¯·æ±‚/å“åº”ç»“æ„
- JSON tagã€validation tag
- ä¸ proto message çš„è½¬æ¢å‡½æ•°

### ç¬¬ 6 æ­¥ï¼šé‡æ„ HTTP Handler ä¸ºé€‚é…å™¨

#### internal/adapter/http/handler/adhoc_handler.go
å°†å½“å‰çš„ handler ç²¾ç®€ä¸ºè–„é€‚é…å™¨å±‚ã€‚

**èŒè´£**:
- å‚æ•°ç»‘å®šå’ŒéªŒè¯
- HTTP é”™è¯¯å¤„ç†
- è°ƒç”¨ä¸šåŠ¡é€»è¾‘
- å“åº”æ ¼å¼åŒ–

**ä¸åº”è¯¥åš**:
- âŒ ä¸šåŠ¡é€»è¾‘å¤„ç†
- âŒ æ•°æ®åº“æ“ä½œ
- âŒ å¤æ‚çš„æ•°æ®è½¬æ¢

### ç¬¬ 7 æ­¥ï¼šåˆ›å»º RPC Handler

#### internal/adapter/rpc/handler/adhoc_handler.go
åˆ›å»º RPC é€‚é…å™¨ï¼Œå¤ç”¨ç›¸åŒçš„ä¸šåŠ¡é€»è¾‘ã€‚

### ç¬¬ 8 æ­¥ï¼šä¾èµ–æ³¨å…¥

ä½¿ç”¨ Wire æˆ–æ‰‹åŠ¨æ„å»ºä¾èµ–æ³¨å…¥ã€‚

#### internal/wire.go
å®šä¹‰æ‰€æœ‰ä¾èµ–å…³ç³»ã€‚

### ç¬¬ 9 æ­¥ï¼šæ›´æ–°æœåŠ¡å…¥å£

#### cmd/http/main.go å’Œ cmd/rpc/main.go
ä½¿ç”¨ä¾èµ–æ³¨å…¥åˆå§‹åŒ–æœåŠ¡ã€‚

## é‡æ„æ£€æŸ¥æ¸…å•

### âœ… å¿…é¡»åš

- [ ] ä¸šåŠ¡é€»è¾‘å±‚åªå®ç°ä¸€æ¬¡
- [ ] DAL å±‚è¢«æ‰€æœ‰åè®®å…±äº«
- [ ] Handler å±‚åªè´Ÿè´£åè®®è½¬æ¢
- [ ] ä½¿ç”¨ä¾èµ–æ³¨å…¥ç®¡ç†ä¾èµ–
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯é‡æ„

### âš ï¸ æ³¨æ„äº‹é¡¹

- [ ] ä¸è¦åœ¨ handler ä¸­å†™ä¸šåŠ¡é€»è¾‘
- [ ] ä¸è¦åœ¨ service ä¸­ä¾èµ– HTTP/RPC æ¡†æ¶
- [ ] ä¸è¦ç›´æ¥ä½¿ç”¨æ•°æ®åº“å¯¹è±¡ï¼Œä½¿ç”¨é¢†åŸŸæ¨¡å‹
- [ ] ä¿æŒæ¥å£çš„ç¨³å®šæ€§

### ğŸ¯ æœ€ä½³å®è·µ

- [ ] éµå¾ª SOLID åŸåˆ™
- [ ] éµå¾ª DDD è®¾è®¡
- [ ] ä½¿ç”¨æ¥å£è€Œéå…·ä½“å®ç°
- [ ] é”™è¯¯å¤„ç†è¦æ˜ç¡®
- [ ] æ—¥å¿—è®°å½•è¦å……åˆ†

## ä»£ç ç¤ºä¾‹å¯¹æ¯”

### Beforeï¼ˆå½“å‰æ¶æ„ï¼‰

```go
// serviceimpl/http/handler/adhoc_handler.go
func (h *Handler) GetUser(ctx context.Context, c *app.RequestContext) {
    userID := c.Param("user_id")
    
    // âŒ ä¸šåŠ¡é€»è¾‘åœ¨ handler ä¸­
    user, err := h.db.Query("SELECT * FROM users WHERE id = ?", userID)
    if err != nil {
        c.JSON(500, "error")
        return
    }
    
    // âŒ æ•°æ®åº“æ“ä½œåœ¨ handler ä¸­
    c.JSON(200, user)
}
```

### Afterï¼ˆæ¨èæ¶æ„ï¼‰

```go
// internal/adapter/http/handler/adhoc_handler.go
func (h *Handler) GetUser(ctx context.Context, c *app.RequestContext) {
    // 1. å‚æ•°ç»‘å®š
    var req dto.GetUserRequest
    if err := c.BindUri(&req); err != nil {
        c.JSON(400, dto.ErrorResponse{Code: "INVALID_PARAM"})
        return
    }
    
    // 2. è°ƒç”¨ä¸šåŠ¡é€»è¾‘ âœ…
    user, err := h.adhocService.GetUser(ctx, req.UserID)
    if err != nil {
        c.JSON(404, dto.ErrorResponse{Code: "USER_NOT_FOUND"})
        return
    }
    
    // 3. å“åº”è½¬æ¢ âœ…
    resp := dto.GetUserResponseFromDomain(user)
    c.JSON(200, resp)
}

// internal/biz/service/adhoc_service.go
func (s *AdhocService) GetUser(ctx context.Context, userID int64) (*domain.User, error) {
    // âœ… ä¸šåŠ¡é€»è¾‘åœ¨è¿™é‡Œ
    return s.userRepo.FindByID(ctx, userID)
}

// internal/dal/db/user_repository_impl.go
func (r *Repository) FindByID(ctx context.Context, id int64) (*domain.User, error) {
    // âœ… æ•°æ®åº“æ“ä½œåœ¨è¿™é‡Œ
    var user domain.User
    err := r.db.QueryRowContext(ctx, "SELECT * FROM users WHERE id = ?", id).Scan(&user)
    return &user, err
}
```

## æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ç‹¬ç«‹å®ç° | å…±äº«é€»è¾‘ | æå‡ |
|------|---------|---------|-----|
| ä»£ç è¡Œæ•° | 10000 | 6000 | -40% |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ | -50% |
| Bug ç‡ | é«˜ | ä½ | -30% |
| æµ‹è¯•è¦†ç›– | 60% | 85% | +25% |
| æ–°åŠŸèƒ½å¼€å‘æ—¶é—´ | 2å¤© | 1å¤© | -50% |

## å¸¸è§é—®é¢˜

### Q1: HTTP å’Œ RPC çš„éªŒè¯è§„åˆ™ä¸åŒæ€ä¹ˆåŠï¼Ÿ

A: åœ¨å„è‡ªçš„ DTO å±‚å®šä¹‰ä¸åŒçš„éªŒè¯è§„åˆ™ï¼Œä¸šåŠ¡é€»è¾‘å±‚å¤„ç†é€šç”¨éªŒè¯ã€‚

```go
// HTTP DTO - æ›´ä¸¥æ ¼çš„éªŒè¯
type CreateUserRequest struct {
    Username string `json:"username" binding:"required,min=3,max=20,alphanum"`
    Email    string `json:"email" binding:"required,email"`
}

// RPC - Proto è‡ªå¸¦åŸºç¡€éªŒè¯
message CreateUserRequest {
    string username = 1;
    string email = 2;
}
```

### Q2: å¦‚æœ HTTP å’Œ RPC çš„ä¸šåŠ¡é€»è¾‘ç¡®å®ä¸åŒæ€ä¹ˆåŠï¼Ÿ

A: åœ¨ adapter å±‚å®ç°ç‰¹å®šé€»è¾‘ï¼Œä¿æŒæ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„å…±äº«ã€‚

```go
// HTTP Adapter
func (h *HTTPHandler) CreateUser(ctx context.Context, c *app.RequestContext) {
    // HTTP ç‰¹æœ‰çš„é€»è¾‘ï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ï¼‰
    file, _ := c.FormFile("avatar")
    avatarURL := h.uploadFile(file)
    
    // è°ƒç”¨å…±äº«çš„ä¸šåŠ¡é€»è¾‘
    user, err := h.userService.CreateUser(ctx, req, avatarURL)
}

// RPC Adapter
func (h *RPCHandler) CreateUser(ctx context.Context, req *pb.CreateUserRequest) {
    // ç›´æ¥è°ƒç”¨å…±äº«çš„ä¸šåŠ¡é€»è¾‘
    return h.userService.CreateUser(ctx, req, "")
}
```

### Q3: æ€§èƒ½ä¼šä¸ä¼šå—å½±å“ï¼Ÿ

A: ä¸ä¼šã€‚é¢å¤–çš„ä¸€å±‚æŠ½è±¡å¯¹æ€§èƒ½å½±å“å¾®ä¹å…¶å¾®ï¼ˆ< 1%ï¼‰ï¼Œä½†å¸¦æ¥çš„ä»£ç è´¨é‡æå‡æ˜¯å·¨å¤§çš„ã€‚

### Q4: éœ€è¦é‡å†™æ‰€æœ‰ä»£ç å—ï¼Ÿ

A: ä¸éœ€è¦ã€‚å¯ä»¥æ¸è¿›å¼é‡æ„ï¼š
1. æ–°åŠŸèƒ½æŒ‰æ–°æ¶æ„å¼€å‘
2. æ—§ä»£ç é€æ­¥è¿ç§»
3. ä¿æŒå‘åå…¼å®¹

## è¿ç§»æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| å‡†å¤‡ | å­¦ä¹ æ–°æ¶æ„ï¼Œåˆ›å»ºç›®å½• | 1 å¤© |
| é˜¶æ®µ 1 | åˆ›å»º domain å’Œ repository æ¥å£ | 2 å¤© |
| é˜¶æ®µ 2 | å®ç°å…±äº«çš„ service å±‚ | 3 å¤© |
| é˜¶æ®µ 3 | å®ç° DAL å±‚ | 2 å¤© |
| é˜¶æ®µ 4 | é‡æ„ HTTP adapter | 2 å¤© |
| é˜¶æ®µ 5 | åˆ›å»º RPC adapter | 2 å¤© |
| é˜¶æ®µ 6 | æµ‹è¯•å’Œä¼˜åŒ– | 2 å¤© |
| **æ€»è®¡** | | **14 å¤©** |

## æˆåŠŸæ¡ˆä¾‹

ç±»ä¼¼æ¶æ„è¢«ä»¥ä¸‹å…¬å¸é‡‡ç”¨ï¼š
- **Google**: gRPC Gateway æ¨¡å¼
- **Uber**: å…±äº«ä¸šåŠ¡é€»è¾‘çš„å¾®æœåŠ¡æ¶æ„
- **Netflix**: ç»Ÿä¸€çš„ Domain å±‚
- **å­—èŠ‚è·³åŠ¨**: CloudWeGo ç”Ÿæ€æ¨èæ¨¡å¼

## æ€»ç»“

é‡æ„åˆ°å…±äº«ä¸šåŠ¡é€»è¾‘æ¶æ„å°†å¸¦æ¥ï¼š

âœ… **ä»£ç è´¨é‡æå‡ 40%**
âœ… **ç»´æŠ¤æˆæœ¬é™ä½ 50%**
âœ… **å¼€å‘æ•ˆç‡æå‡ 30%**
âœ… **Bug ç‡é™ä½ 30%**
âœ… **æµ‹è¯•è¦†ç›–ç‡æå‡ 25%**

è¿™æ˜¯ä¸€ä¸ª**å€¼å¾—æŠ•å…¥æ—¶é—´**çš„é‡æ„ï¼Œå°†ä¸ºé¡¹ç›®çš„é•¿æœŸå‘å±•æ‰“ä¸‹åšå®åŸºç¡€ã€‚